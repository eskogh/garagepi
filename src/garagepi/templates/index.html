<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Garage Door Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url("https://fonts.googleapis.com/css?family=Raleway");
    :root{
      --glow-color-open:  hsl(111, 94%, 44%);
      --glow-color-closed:hsl(32, 94%, 45%);
      --glow-color-moving:hsl(0, 0%, 66%);
      --glow-color-error: hsl(0, 100%, 38%);
      --glow-color: var(--glow-color-moving);
    }
    body.open   { --glow-color: var(--glow-color-open); }
    body.closed { --glow-color: var(--glow-color-closed); }
    body.moving { --glow-color: var(--glow-color-moving); }
    body.unknown, body.error { --glow-color: var(--glow-color-error); }

    *,*::before,*::after{ box-sizing:border-box; }
    html, body{ height:100%; width:100%; overflow:hidden; }
    body{
      min-height:100vh; display:flex; justify-content:center; align-items:center;
      background:black; margin:0; font-family:"Raleway", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .glowing-btn{
      position:relative; color:var(--glow-color); cursor:pointer; padding:.35em 1em;
      border:.15em solid var(--glow-color); border-radius:.45em; background:none; perspective:2em;
      font-size:2em; font-weight:900; letter-spacing:1em;
      box-shadow: inset 0 0 .5em 0 var(--glow-color), 0 0 .5em 0 var(--glow-color);
      animation:border-flicker 2s linear infinite; transition: transform .12s ease;
    }
    .glowing-btn[disabled]{ cursor:not-allowed; opacity:.6; filter:grayscale(40%); animation:none; }
    .glowing-txt{ float:left; margin-right:-.8em; text-shadow:0 0 .125em hsl(0 0% 100% / .3), 0 0 .45em var(--glow-color); animation:text-flicker 3s linear infinite; }
    .faulty-letter{ opacity:.5; animation:faulty-flicker 2s linear infinite; }
    .glowing-btn::before{ content:""; position:absolute; inset:0; opacity:.7; filter:blur(1em); transform:translateY(120%) rotateX(95deg) scale(1,.35); background:#000; pointer-events:none; }
    .glowing-btn::after{ content:""; position:absolute; inset:0; opacity:0; z-index:-1; background:#000; box-shadow:0 0 2em .2em var(--glow-color); transition:opacity 100ms linear; }
    .glowing-btn:hover:not([disabled]){ color:rgba(0,0,0,.8); text-shadow:none; animation:none; }
    .glowing-btn:hover:not([disabled]) .glowing-txt{ animation:none; }
    .glowing-btn:hover:not([disabled]) .faulty-letter{ animation:none; opacity:1; }
    .glowing-btn:hover:not([disabled])::before{ filter:blur(1.5em); opacity:1; }
    .glowing-btn:hover:not([disabled])::after{ opacity:1; }

    @keyframes faulty-flicker{ 0%,2%{opacity:.1} 4%,19%{opacity:.5} 21%{opacity:.1} 23%{opacity:1} 80%{opacity:.5} 83%{opacity:.4} 87%{opacity:1} }
    @keyframes text-flicker{ 0%{opacity:.1} 2%{opacity:1} 8%{opacity:.1} 9%{opacity:1} 12%{opacity:.1} 20%{opacity:1} 25%{opacity:.3} 30%{opacity:1} 70%{opacity:.7} 72%{opacity:.2} 77%{opacity:.9} 100%{opacity:.9} }
    @keyframes border-flicker{ 0%{opacity:.1} 2%{opacity:1} 4%{opacity:.1} 8%{opacity:1} 70%{opacity:.7} 100%{opacity:1} }
    @media (prefers-reduced-motion: reduce){ .glowing-btn, .glowing-txt, .faulty-letter{ animation:none !important; } }
    @media (max-width:600px){ .glowing-btn{ font-size:1.25em; letter-spacing:.6em; } }

    /* Tiny Close-mode pill */
    .pill {
      position: fixed; top: 14px; right: 14px;
      display:flex; align-items:center; gap:.6rem;
      background: rgba(20,20,20,.7);
      color: #ddd; padding:.5rem .8rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(4px);
      font-size:.9rem; user-select:none;
    }
    .switch {
      width: 44px; height: 24px; background:#444; border-radius:999px; position:relative; cursor:pointer;
      box-shadow: inset 0 0 4px rgba(0,0,0,.6);
    }
    .switch::after {
      content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%;
      background:#bbb; transition:left .18s ease;
    }
    .switch.on { background:#0fa; }
    .switch.on::after { left:23px; background:#fff; }
  </style>
</head>

<body class="{{ door_status|lower }}">
  <!-- Close-mode pill -->
  <div class="pill" title="Auto-close (Close Mode)">
    <span>Close&nbsp;Mode</span>
    <div id="cm-switch" class="switch{{ ' on' if close_mode else '' }}"></div>
  </div>

  <!-- Main neon button -->
  {% if door_status == "Closed" %}
    <button class="glowing-btn" id="toggle-btn"><span class='glowing-txt'>OP<span class='faulty-letter'>E</span>N</span></button>
  {% elif door_status == "Open" %}
    <button class="glowing-btn" id="toggle-btn"><span class='glowing-txt'>C<span class='faulty-letter'>L</span>OSE</span></button>
  {% elif door_status == "Moving" %}
    <button class="glowing-btn" id="toggle-btn" disabled><span class='glowing-txt'>IN <span class='faulty-letter'>P</span>RO<span class='faulty-letter'>G</span>RESS</span></button>
  {% else %}
    <button class="glowing-btn" id="toggle-btn" disabled><span class='glowing-txt'><span class='faulty-letter'>CHECK&nbsp;SENSORS</span></span></button>
  {% endif %}

  <script>
    const API_TOKEN = ""; // if you enabled API auth in app.py

    const btn  = document.getElementById("toggle-btn");
    const cmEl = document.getElementById("cm-switch");
    let busy = false;

    function headersJson(){
      return {
        "Content-Type":"application/json",
        ...(API_TOKEN? {"Authorization":"Bearer "+API_TOKEN}:{})
      };
    }

    function setBusy(on){
      busy = !!on;
      if(btn){
        if(on) btn.setAttribute("disabled","disabled");
        else btn.removeAttribute("disabled");
      }
    }

    function setCloseModeUI(on){
      cmEl.classList.toggle("on", !!on);
    }

    function setBodyState(state){
      document.body.className = (state || "unknown").toLowerCase();
      // also alter button label:
      if(!btn) return;
      if(state === "Closed"){
        btn.innerHTML = "<span class='glowing-txt'>OP<span class='faulty-letter'>E</span>N</span>";
        btn.removeAttribute("disabled");
      }else if(state === "Open"){
        btn.innerHTML = "<span class='glowing-txt'>C<span class='faulty-letter'>L</span>OSE</span>";
        btn.removeAttribute("disabled");
      }else if(state === "Moving"){
        btn.innerHTML = "<span class='glowing-txt'>IN <span class='faulty-letter'>P</span>RO<span class='faulty-letter'>G</span>RESS</span>";
        btn.setAttribute("disabled","disabled");
      }else{
        btn.innerHTML = "<span class='glowing-txt'><span class='faulty-letter'>CHECK&nbsp;SENSORS</span></span>";
        btn.setAttribute("disabled","disabled");
      }
    }

    async function refresh(){
      try{
        const res = await fetch("/status", {headers: headersJson()});
        const data = await res.json();
        setBodyState(data.status);
        setCloseModeUI(data.close_mode);
        if(data.close_mode && btn) btn.setAttribute("disabled","disabled");
      }catch(e){
        document.body.className = "error";
        if(btn) btn.setAttribute("disabled","disabled");
      }
    }

    async function toggleDoor(){
      if(busy) return;
      setBusy(true);
      try{
        const res = await fetch("/toggle", {method:"POST", headers: headersJson()});
        if(res.status === 403){
          alert("Door operation blocked (Close Mode is enabled).");
        }
      }finally{
        setTimeout(()=>setBusy(false), 1200);
        setTimeout(refresh, 300);
      }
    }

    async function toggleCloseMode(){
      const enable = !cmEl.classList.contains("on");
      try{
        await fetch("/set_close_mode", {
          method:"POST",
          headers: headersJson(),
          body: JSON.stringify({enabled: enable})
        });
        setCloseModeUI(enable);
        if(enable && btn) btn.setAttribute("disabled","disabled");
        setTimeout(refresh, 200);
      }catch(e){}
    }

    if(btn)  btn.addEventListener("click", toggleDoor);
    cmEl.addEventListener("click", toggleCloseMode);

    refresh();
    setInterval(refresh, 1500);
  </script>
</body>
</html>
